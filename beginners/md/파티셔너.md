# 파티셔너란

- 프로듀서가 데이터를 보내면 무조건 **파티셔너를 통해서** 브로커로 데이터가 전송됩니다.


- ![](/images/2022-06-02-17-42-07.png)

- 파티셔너는 데이터를 토픽의 어떤 파티션에 넣을지 결정하는 역할을 합니다.
- 레코드에 포함된 메시지 키 또는 메시지 값에 따라서 파티션의 위치가 결정됩니다.
- 프로듀서를 사용할 때 파티셔너를 따로 설정하지 않으면 `UniformStickyPartitioner` 로 설정이 된다.
- 이 파티셔너는 메세지 키가 있을떄와 없을때가 다르게 동작하게 되는데, 우선 메시지 키가 있는 경우를 살펴보자

메시지 키를 가진 레코드는 파티셔너에 의해서 특정한 해시값으로 생성이 된다.

![](/images/2022-06-02-17-43-33.png)

- 이 해시값을 기준으로 어떤 파티션에 들어갈 지 결정된다.
- 파티셔너의 해쉬로직에 의해서 서울은 파티션 0번, 부산은 파티션 1번, 울산은 파티션 0번으로 들어갈 수 있다.

![](/images/2022-06-02-17-44-29.png)

- 동일한 메세지 키를 가진 레코드는 동일한 해시값을 만들어내는 것을 보장하기 때문에 동일한 파티션에 들어가는 것이 보장된다.
- 동일한 메시지 키를 가진 레코드들은 동일한 파티션에 들어가기 때문에 순서를 지켜서 데이터를 처리할 수 있다는 장점이 있습니다.

- 그래서 키를 잘 설정하면 컨슈머는 순서를 지켜서 데이터를 지켜서 처리할 수 있게 되는 것입니다.


메시지 키가 없는 경우
- 라운드 로빈 방식으로 돌아갑니다.
- UniformStickyPartitioner 는 사실 조금 전통적인 라운드 로빈과 다르다.
  - 프로듀서에서 배치로 모을 수 있는 최대한의 레코드들을 모아서, 파티션으로 데이터를 보내게 됩니다.
  - 배치 단위로 데이터를 보낼 때 파티션 라운드 로빈 방식으로 보낸다.
  - 메시지 키가 없는 것들은 파티션에 적절히 분배가 된다는 것


카프카에서는 커스텀 파티셔너를 만들 수 있도록 파티셔너 인터페이스를 제공하고 있다.
- 커스텀 파티셔너를 만들면, 메시지키, 메시지 값, 토픽 이름에 따라 어떤 파티션에 값을 보낼 지 지정할 수 있다.
- 언제 쓸 수 있는가?
  - VIP 고객을 위해 데이터 처리를 더 빠르게 하는 것을 생각해볼 수 있다.
  - VIP 고객을 위해 파티셔너를 통해 처리량을 더 늘릴 수 있다.
    - 기본적으로 10개의 파티션이 있다고 가정했을 때, 8개는 VIP, 2개는 일반 고객 파티션으로 동작하도록 할 수 있다.
    - 이것은 마치, AMQP 기반 메시지 시스템에서 우선순위 큐 시스템을 만드는 것과 동일하다고 볼 수 있다.
